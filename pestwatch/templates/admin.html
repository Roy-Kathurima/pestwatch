{% include "navbar.html" %}

<div class="container" style="margin-top:18px;">
  <div class="left">
    <div class="card">
      <h2>Admin — Reports</h2>

      <table>
        <thead>
          <tr><th>ID</th><th>User</th><th>Title</th><th>When</th><th>Approved</th><th>Action</th></tr>
        </thead>
        <tbody>
        {% for r in reports %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.user.username if r.user else '—' }}</td>
            <td>{{ r.title }}</td>
            <td>{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>{{ 'Yes' if r.approved else 'No' }}</td>
            <td>
              {% if not r.approved %}
                <form method="post" action="{{ url_for('admin_approve', report_id=r.id) }}">
                  <button class="btn-primary" type="submit">Approve</button>
                </form>
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <p style="margin-top:8px;"><a class="btn" href="{{ url_for('admin_export') }}">Export CSV</a> <a class="btn" href="{{ url_for('admin_logins') }}">View login logs</a></p>
    </div>
  </div>

  <div class="right">
    <div class="card">
      <h3>Reports map</h3>
      <div id="map" style="height:320px;"></div>
    </div>

    <div class="card">
      <h3>Stats</h3>
      <canvas id="statusChart" height="180"></canvas>
      <canvas id="lineChart" height="180" style="margin-top:14px;"></canvas>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
  // render admin map with all reports
  const reports = {{ reports|tojson }};
  loadMap(reports);

  // charts
  fetch('{{ url_for("admin_stats") }}')
    .then(r => r.json())
    .then(data => {
      renderStatusChart('statusChart', data.approved, data.pending);
      renderLineChart('lineChart', data.days, data.counts);
    });
</script>
