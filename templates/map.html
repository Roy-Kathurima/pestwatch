{% extends "base.html" %}
{% block content %}
  <h2>Reports Map</h2>
  <div id="map" style="width:100%; height:600px;"></div>

  <!-- Leaflet CSS/JS from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- leaflet-heat plugin -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
  const map = L.map('map').setView([0.0, 37.0], 6); // centered on Kenya-ish
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  // fetch reports
  fetch("{{ url_for('api_reports') }}")
    .then(r => r.json())
    .then(data => {
      const heatPoints = [];
      data.forEach(rep => {
        if (rep.lat && rep.lon) {
          const marker = L.marker([rep.lat, rep.lon]).addTo(map);
          let popup = `<b>${rep.pest_name}</b><br>${rep.description || ""}<br>By: ${rep.user}<br>${new Date(rep.created_at).toLocaleString()}`;
          if (rep.image) popup += `<br><a href="${rep.image}" target="_blank">Photo</a>`;
          marker.bindPopup(popup);
          heatPoints.push([rep.lat, rep.lon, 0.5]); // 3rd param intensity
        }
      });

      // heat layer
      if (heatPoints.length) {
        L.heatLayer(heatPoints, {radius: 25}).addTo(map);
      }
    })
    .catch(err => console.error(err));
  </script>
{% endblock %}
