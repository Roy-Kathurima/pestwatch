<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard - {{ user.fullname }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>#map{height:400px;margin-bottom:1rem}</style>
</head>
<body>
  <h2>Welcome, {{ user.fullname }}</h2>
  <p><a href="{{ url_for('new_report', user_id=user.id) }}">New report</a></p>

  <div id="map"></div>

  <h3>Your reports</h3>
  <ul>
    {% for r in reports %}
      <li>{{ r.title }} - {{ r.status }} {% if r.latitude %} ({{ r.latitude }},{{ r.longitude }}){% endif %}</li>
    {% endfor %}
  </ul>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const markers = {{ markers|tojson }};
    const map = L.map('map').setView([0,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    if(markers.length){
      const group = [];
      markers.forEach(m=>{
        const mk = L.marker([m.lat,m.lon]).addTo(map).bindPopup(m.title || 'Report');
        group.push([m.lat,m.lon]);
      });
      map.fitBounds(group);
    }
  </script>
</body>
</html>
