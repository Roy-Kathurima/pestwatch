{% extends "base.html" %}
{% block content %}
<h2>Admin Dashboard</h2>

<p>
  <a class="btn" href="{{ url_for('admin_export') }}">Export CSV</a>
</p>

<div id="adminMap" style="width:100%; height:400px; border:1px solid #ccc;"></div>

<h3>Reports</h3>
<table class="data-table" id="repTable">
<tr><th>ID</th><th>User</th><th>Severity</th><th>Verified</th><th>Image</th><th>Date</th><th>Action</th></tr>
{% for r in reports %}
<tr>
  <td>{{ r.id }}</td>
  <td>{{ r.farmer.fullname if r.farmer else 'Unknown' }}</td>
  <td>{{ r.severity }}</td>
  <td>{{ 'Yes' if r.verified else 'No' }}</td>
  <td>{% if r.image_filename %}<a href="{{ url_for('uploaded_file', filename=r.image_filename) }}" target="_blank">View</a>{% else %}No Image{% endif %}</td>
  <td>{{ r.created_at }}</td>
  <td>
    <button onclick="toggleVerify({{ r.id }})">{{ 'Unverify' if r.verified else 'Verify' }}</button>
    <button onclick="openFeedback({{ r.id }}, {{ r.latitude }}, {{ r.longitude }}, '{{ (r.admin_feedback or '')|replace('\\','\\\\')|replace(\"'\",\"\\'\") }}', '{{ r.status }}', '{{ r.severity }}')">Feedback</button>
  </td>
</tr>
{% endfor %}
</table>

<!-- Feedback modal (simple) -->
<div id="feedbackBox" style="display:none; position:fixed; left:10%; top:10%; width:80%; background:white; padding:16px; border:1px solid #666; z-index:9999;">
  <h3>Provide feedback</h3>
  <form id="feedbackForm" method="post">
    <input type="hidden" name="report_id" id="fb_report_id">
    <label>Feedback</label>
    <textarea name="feedback" id="fb_feedback" style="width:100%; height:80px;"></textarea>
    <label>Status</label>
    <select name="status" id="fb_status">
      <option value="new">New</option>
      <option value="in_progress">In Progress</option>
      <option value="resolved">Resolved</option>
    </select>
    <label>Severity</label>
    <select name="severity" id="fb_severity">
      <option>Low</option><option>Moderate</option><option>Severe</option><option>Critical</option>
    </select>

    <p>
      <button type="button" class="btn" onclick="submitFeedback()">Save</button>
      <button type="button" class="btn btn-secondary" onclick="closeFeedback()">Close</button>
      <button type="button" class="btn btn-danger" onclick="gotoLocation()">Go to Location</button>
    </p>
  </form>
</div>

<script>
const map = L.map('adminMap').setView([0.3,37.7], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

const reports = {{ reports|tojson }};
let markers = [];

function drawMarkers(){
  markers.forEach(m=>map.removeLayer(m));
  markers = [];
  reports.forEach(r=>{
    if(!r.latitude || !r.longitude) return;
    const color = (r.severity==='Low')? 'green' : (r.severity==='Moderate')? 'orange' : (r.severity==='Severe')? 'red' : 'purple';
    const m = L.marker([r.latitude, r.longitude]).addTo(map);
    let popup = `<b>ID:</b> ${r.id}<br><b>User:</b> ${r.farmer ? r.farmer.fullname : 'Unknown'}<br><b>Severity:</b> ${r.severity}<br><b>Verified:</b> ${r.verified ? 'Yes':'No'}`;
    if(r.image) popup += `<br><img src="${r.image}" width="180">`;
    m.bindPopup(popup);
    markers.push(m);
  });
}
drawMarkers();

function toggleVerify(id){
  fetch('/admin/toggle_verify/' + id, {method:'POST'}).then(r=>r.json()).then(j=>{
    if(j.success) location.reload();
    else alert('Error');
  });
}

function openFeedback(id, lat, lon, feedback, status, severity){
  document.getElementById('fb_report_id').value = id;
  document.getElementById('fb_feedback').value = feedback || '';
  document.getElementById('fb_status').value = status || 'new';
  document.getElementById('fb_severity').value = severity || 'Low';
  document.getElementById('feedbackBox').style.display = 'block';
  feedbackBox_lat = lat;
  feedbackBox_lon = lon;
}
let feedbackBox_lat=null, feedbackBox_lon=null;
function closeFeedback(){ document.getElementById('feedbackBox').style.display='none'; }

function submitFeedback(){
  const id = document.getElementById('fb_report_id').value;
  const fd = new FormData();
  fd.append('feedback', document.getElementById('fb_feedback').value);
  fd.append('status', document.getElementById('fb_status').value);
  fd.append('severity', document.getElementById('fb_severity').value);
  fetch('/admin/feedback/' + id, {method:'POST', body: fd}).then(()=> location.reload());
}

function gotoLocation(){
  if(feedbackBox_lat && feedbackBox_lon){
    map.setView([feedbackBox_lat, feedbackBox_lon], 14);
    closeFeedback();
  } else {
    alert('No coordinates available for this report.');
  }
}
</script>

{% endblock %}
