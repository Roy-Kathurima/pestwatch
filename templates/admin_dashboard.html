{% extends "base.html" %}
{% block content %}
<h2>Admin Dashboard</h2>

<div style="margin-bottom:12px;">
  <label>From: <input type="date" id="dateFrom"></label>
  <label>To: <input type="date" id="dateTo"></label>
  <label>Severity:
    <select id="severityFilter"><option value="">All</option><option>Low</option><option>Moderate</option><option>Severe</option><option>Critical</option></select>
  </label>
  <button class="btn" onclick="applyFilters()">Apply</button>
  <button class="btn btn-secondary" onclick="toggleHeat()">Toggle Heatmap</button>
</div>

<div id="adminMap" style="width:100%; height:450px; border:1px solid #777; margin-bottom:15px;"></div>

<h3>Reports</h3>
<table class="data-table" id="reportsTable">
  <thead><tr><th>ID</th><th>User</th><th>Severity</th><th>Verified</th><th>Image</th><th>Date</th><th>Action</th></tr></thead>
  <tbody>
    {% for r in reports %}
    <tr data-id="{{ r.id }}" data-severity="{{ r.severity }}" data-verified="{{ 'true' if r.verified else 'false' }}" data-date="{{ r.created_at.date() }}">
      <td>{{ r.id }}</td>
      <td>{{ r.farmer.fullname }}</td>
      <td>{{ r.severity }}</td>
      <td>{{ 'Yes' if r.verified else 'No' }}</td>
      <td>{% if r.image_filename %}<a href="{{ url_for('uploaded_file', filename=r.image_filename) }}" target="_blank">View</a>{% else %}No Image{% endif %}</td>
      <td>{{ r.created_at }}</td>
      <td>
        <form method="post" action="{{ url_for('admin_feedback', report_id=r.id) }}" style="display:inline;">
          <input name="feedback" placeholder="Feedback" value="{{ r.admin_feedback or '' }}">
          <button class="btn" type="submit">Save</button>
        </form>
        <button class="btn btn-secondary" onclick="toggleVerify({{ r.id }})">
          {% if r.verified %}Unverify{% else %}Verify{% endif %}
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.min.js"></script>
<script>
const ICONS = {
  Low: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
  Moderate: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
  Severe: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
  Critical: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png'
};
const SHADOW = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png';
function makeIcon(url){
  return L.icon({iconUrl:url, shadowUrl:SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]});
}
const icons = {Low: makeIcon(ICONS.Low), Moderate: makeIcon(ICONS.Moderate), Severe: makeIcon(ICONS.Severe), Critical: makeIcon(ICONS.Critical)};

var map = L.map('adminMap').setView([0.3,37.7],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let markers = [], heatLayer=null, allReports=[];

function loadReports(){
  fetch('/api/reports').then(r=>r.json()).then(data=>{ allReports=data; drawMarkers(data); });
}
function drawMarkers(data){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  let heatPts=[];
  data.forEach(rep=>{
    if (!rep.lat || !rep.lon) return;
    const icon = icons[rep.severity] || icons.Low;
    const m = L.marker([rep.lat, rep.lon], {icon}).addTo(map);
    let popup = `<b>ID:</b>${rep.id}<br><b>User:</b>${rep.user}<br><b>Severity:</b>${rep.severity}<br><b>Verified:</b>${rep.verified ? 'Yes':'No'}<br>`;
    if (rep.image) popup += `<img src="${rep.image}" width="180">`;
    m.bindPopup(popup);
    markers.push(m);
    let weight = rep.severity === 'Critical' ? 1.0 : rep.severity === 'Severe' ? 0.8 : rep.severity === 'Moderate' ? 0.5 : 0.2;
    heatPts.push([rep.lat, rep.lon, weight]);
  });
  if (!heatLayer) heatLayer = L.heatLayer(heatPts,{radius:25,blur:15}); else heatLayer.setLatLngs(heatPts);
  if (!map.hasLayer(heatLayer)) heatLayer.addTo(map);
}

function applyFilters(){
  const from = document.getElementById('dateFrom').value;
  const to = document.getElementById('dateTo').value;
  const severity = document.getElementById('severityFilter').value;
  const filtered = allReports.filter(r=>{
    if (severity && r.severity !== severity) return false;
    if (from && new Date(r.created_at) < new Date(from)) return false;
    if (to && new Date(r.created_at) > new Date(to+'T23:59:59')) return false;
    return true;
  });
  drawMarkers(filtered);
  // table filtering:
  const tbody = document.querySelector('#reportsTable tbody');
  tbody.innerHTML = '';
  filtered.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.id}</td><td>${r.user}</td><td>${r.severity}</td><td>${r.verified ? 'Yes' : 'No'}</td><td>${r.image ? '<a href="'+r.image+'" target="_blank">View</a>' : 'No Image'}</td><td>${r.created_at}</td><td><button class="btn btn-secondary" onclick="toggleVerify(${r.id})">${r.verified ? 'Unverify':'Verify'}</button></td>`;
    tbody.appendChild(tr);
  });
}

function toggleVerify(id){
  fetch('/admin/toggle_verify/'+id, {method:'POST'}).then(r=>r.json()).then(j=>{
    if (j.success) loadReports();
    else alert('Error toggling verify');
  });
}

function toggleHeat(){
  if (!heatLayer) return;
  if (map.hasLayer(heatLayer)) map.removeLayer(heatLayer); else heatLayer.addTo(map);
}

loadReports();
</script>
{% endblock %}
