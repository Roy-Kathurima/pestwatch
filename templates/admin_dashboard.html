<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>#map{height:360px;margin-bottom:12px}</style>
</head>
<body>
  <header class="topbar">
    <h1>Admin - PestWatch</h1>
    <nav>
      <a href="{{ url_for('admin_database') }}">Database</a>
      <a href="{{ url_for('admin_logout') }}">Logout</a>
    </nav>
  </header>
  <main class="container">
    <h2>All reports</h2>
    <div id="map"></div>

    <div>
      <table class="table">
        <thead><tr><th>ID</th><th>Title</th><th>User</th><th>Coords</th><th>Status</th><th>Created</th></tr></thead>
        <tbody id="reports-table"></tbody>
      </table>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const reports = {{ reports | tojson | safe }};
    const map = L.map('map').setView([0.0236, 37.9062], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const tbody = document.getElementById('reports-table');
    let markers = [];
    reports.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.id}</td><td>${r.title}</td><td>${r.user_id||''}</td>
                      <td>${r.latitude||''}, ${r.longitude||''}</td>
                      <td>${r.status}</td><td>${r.created_at}</td>`;
      tbody.appendChild(tr);
      if (r.latitude && r.longitude) {
        const m = L.marker([r.latitude, r.longitude]).addTo(map).bindPopup(`<b>${r.title}</b>`);
        markers.push(m);
      }
    });
    if (markers.length) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  </script>
</body>
</html>
