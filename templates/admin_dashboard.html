<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin - Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<div class="container">
  <h2>Admin dashboard</h2>
  <p>Counts: users={{ counts.users }} reports={{ counts.reports }} verified={{ verified_count }}</p>
  <p><a href="{{ url_for('admin_database') }}?pwd={{ request.args.get('pwd', '') }}" class="btn">Database (users/reports/logins)</a></p>

  <div id="map" style="height: 380px; margin-bottom:12px;"></div>

  <h3>Recent reports</h3>
  <ul>
    {% for r in reports[:30] %}
      <li>{{ r.created_at.strftime('%Y-%m-%d %H:%M') }} — {{ r.title }} — by {{ r.user.email }} — status: {{ r.status }}</li>
    {% else %}
      <li>No reports.</li>
    {% endfor %}
  </ul>
</div>

<script>
  const map = L.map('map').setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

  const reports = [
    {% for r in reports %}
      {% if r.latitude and r.longitude %}
        {lat: {{ r.latitude }}, lon: {{ r.longitude }}, title: "{{ r.title|e }}", user: "{{ r.user.email|e }}"},
      {% endif %}
    {% endfor %}
  ];

  if (reports.length) {
    const group = [];
    reports.forEach(r => {
      const marker = L.marker([r.lat, r.lon]).addTo(map).bindPopup(`<strong>${r.title}</strong><br>${r.user}`);
      group.push(marker);
    });
    const g = L.featureGroup(group);
    map.fitBounds(g.getBounds().pad(0.2));
  } else {
    map.setView([0,0], 2);
  }
</script>
</body>
</html>
