{% extends "base.html" %}
{% block content %}
<h2>Submit Pest Report</h2>
<form method="post" enctype="multipart/form-data">
  <label>Description</label>
  <textarea name="description" required></textarea>

  <label>Severity</label>
  <select name="severity" required>
    <option value="Low">Low infestation</option>
    <option value="Moderate">Moderate infestation</option>
    <option value="Severe">Severe infestation</option>
    <option value="Critical">Critical outbreak</option>
  </select>

  <label>Image</label>
  <input type="file" name="image" accept="image/*">

  <label>Latitude</label>
  <input name="latitude" id="lat" readonly required>
  <label>Longitude</label>
  <input name="longitude" id="lon" readonly required>

  <p>
    <button type="button" class="btn" onclick="openMap()">Pick location on map</button>
    <button type="button" class="btn btn-secondary" onclick="detect()">Use device location</button>
    <button type="submit" class="btn">Submit Report</button>
  </p>
</form>

<div id="mapBox" style="display:none; height:400px; margin-top:12px;"></div>

<script>
let map, marker;
function openMap(){
  document.getElementById('mapBox').style.display = 'block';
  if(!map){
    map = L.map('mapBox').setView([0.1,37], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
    map.on('click', function(e){
      const lat = e.latlng.lat.toFixed(6);
      const lon = e.latlng.lng.toFixed(6);
      document.getElementById('lat').value = lat;
      document.getElementById('lon').value = lon;
      if(marker) marker.setLatLng(e.latlng);
      else marker = L.marker(e.latlng).addTo(map);
    });
  }
}

function detect(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(pos){
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      document.getElementById('lat').value = lat;
      document.getElementById('lon').value = lon;
      if(!map){
        openMap();
        map.setView([lat,lon], 13);
      }
      if(marker) marker.setLatLng([lat,lon]);
      else marker = L.marker([lat,lon]).addTo(map);
    }, function(err){
      alert('Could not get location: ' + err.message);
    });
  } else {
    alert('Geolocation not supported.');
  }
}
</script>
{% endblock %}
